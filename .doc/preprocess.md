# Preprocess模块文档

## 概述

Preprocess模块负责数据预处理，主要包括PDF文献解析、CSV数据加载和PMC文献下载等功能。该模块为系统提供了从不同来源获取和处理学术文献的能力，是知识库构建的重要基础。

## 核心组件

### PDF解析 (ParsePDF.py)
- 实现PDF文献到XML和Markdown格式的转换
- 通过Grobid服务提取文献结构化信息
- 支持批量处理和文件分类存储

### CSV数据加载 (LoadCSV.py)
- 支持从CSV文件批量导入文献信息
- 实现PubMed和PMC文献的自动下载和处理
- 提供年份筛选和进度跟踪功能

### PMC文献下载 (DownloadFromPMC.py)
- 通过PMC ID直接下载文献全文
- 解析XML格式并转换为Markdown
- 支持批量下载和断点续传

## 详细功能

### PDF解析 (ParsePDF.py)

#### 主要功能
1. **PDF转XML**
   - 通过Grobid服务解析PDF文献
   - 提取文献的结构化信息
   - 支持批量处理和跳过已存在文件

2. **XML转Markdown**
   - 将XML格式转换为易于处理的Markdown格式
   - 自动提取文献元数据(DOI、年份等)
   - 按年份和DOI组织文件存储结构

3. **文献组装**
   - 将处理后的文献整合到知识库目录结构中
   - 支持按年份分类存储
   - 处理特殊字符和路径问题

#### 技术实现
- 使用GrobidConnector连接Grobid服务
- 通过parse_xml函数解析XML结构
- 使用save_to_md函数保存为Markdown格式
- 实现进度条显示处理进度

### CSV数据加载 (LoadCSV.py)

#### 主要功能
1. **CSV文件处理**
   - 读取包含文献信息的CSV文件
   - 支持按年份筛选和排序
   - 处理缺失值和特殊情况

2. **PubMed信息获取**
   - 通过PMID获取文献详细信息
   - 自动查找对应的PMC ID
   - 处理API请求限制和延迟

3. **文献下载与转换**
   - 下载PMC全文XML
   - 解析XML并提取结构化信息
   - 转换为Markdown格式并保存

4. **批量处理与进度跟踪**
   - 支持按年份批量处理
   - 记录处理状态到CSV文件
   - 实现断点续传功能

#### 技术实现
- 使用pandas处理CSV数据
- 通过PubmedUtil获取文献信息
- 实现随机延迟避免API限制
- 使用tqdm显示处理进度
- 通过timer装饰器记录执行时间

### PMC文献下载 (DownloadFromPMC.py)

#### 主要功能
1. **PMC文献下载**
   - 从CSV文件读取PMC ID列表
   - 通过PMC API下载全文XML
   - 提取DOI和年份信息

2. **XML处理与转换**
   - 解析下载的XML文件
   - 提取文献结构和内容
   - 转换为Markdown格式

3. **数据管理**
   - 更新CSV文件中的处理状态
   - 按年份和DOI组织文件
   - 处理下载失败的情况

#### 技术实现
- 使用PMCUtil下载和解析文献
- 实现随机延迟避免API限制
- 使用loguru进行日志记录
- 通过tqdm显示处理进度

## 工作流程

### PDF处理流程
1. 通过GrobidConnector将PDF文件发送到Grobid服务
2. Grobid服务返回结构化的XML文件
3. 解析XML提取文献元数据和内容
4. 转换为Markdown格式并按年份和DOI分类存储
5. 整合到知识库目录结构中

### CSV导入流程
1. 读取CSV文件获取文献基本信息
2. 通过PMID查询PubMed获取详细信息
3. 如果有PMC ID，下载全文XML
4. 解析XML并转换为Markdown
5. 更新CSV文件中的处理状态
6. 按年份批量处理所有文献

### PMC下载流程
1. 从CSV文件读取PMC ID列表
2. 通过PMC API下载全文XML
3. 提取DOI和年份信息并更新CSV
4. 解析XML并转换为Markdown
5. 按年份和DOI组织文件存储

## 技术特点

1. **批量处理能力**
   - 支持大规模文献批量下载和处理
   - 实现多种来源数据的统一处理

2. **错误处理与恢复**
   - 记录处理状态支持断点续传
   - 详细日志记录便于问题排查

3. **资源优化**
   - 实现随机延迟避免API限制
   - 跳过已处理文件提高效率

4. **结构化存储**
   - 按年份和DOI组织文件结构
   - 统一转换为Markdown格式便于后续处理

## 与其他模块的关系

- **与存储模块的关系**：预处理后的文献被存储到指定目录，供存储模块进一步处理
- **与LLM模块的关系**：提供结构化的文献内容，作为LLM模块的知识来源
- **与页面模块的关系**：为FileUpload页面提供底层文件处理功能

## 配置依赖

- 依赖Config模块获取各种路径和API配置
- 需要配置Grobid服务连接信息
- 可能需要配置PubMed和PMC API访问凭证
- 依赖utils模块中的各种工具函数
