# Storage模块文档

## 概述

Storage模块负责系统的数据存储和管理，实现了多种存储后端的连接和操作，包括SQLite关系型数据库、Milvus向量数据库和NebulaGraph图数据库。该模块为系统提供了高效的数据访问、检索和管理能力，是知识库和用户数据管理的核心基础。

## 核心组件

### SQLite存储 (SqliteStore.py)
- 实现基于SQLite的文档存储、引用存储和用户配置存储
- 提供通用的键值对存储接口
- 支持用户、项目和聊天历史管理

### Milvus连接 (MilvusConnection.py)
- 提供Milvus向量数据库的连接和管理
- 实现集合操作和查询功能
- 支持向量索引管理

### Milvus参数 (MilvusParams.py)
- 定义Milvus索引类型和参数
- 提供索引参数生成函数
- 支持多种向量索引算法

### NebulaGraph存储 (NebulaStore.py & NebulaGraph.py)
- 实现NebulaGraph图数据库的连接和操作
- 提供图空间、标签和边类型的管理
- 支持图数据的增删改查

## 详细功能

### SQLite存储 (SqliteStore.py)

#### 主要功能
1. **文档存储**
   - 实现`SqliteBaseStore`通用键值对存储基类
   - 提供`SqliteDocStore`用于存储文档对象
   - 支持批量操作和迭代器接口

2. **引用存储**
   - 实现`ReferenceStore`用于存储文献引用关系
   - 支持引用的添加、查询和删除
   - 提供引用树构建功能

3. **用户配置存储**
   - 实现`ProfileStore`用于管理用户信息
   - 支持用户认证和权限管理
   - 提供项目和聊天历史管理

#### 技术实现
- 使用SQLite3作为底层存储引擎
- 实现LangChain的`BaseStore`接口
- 使用序列化和反序列化处理复杂对象
- 提供事务支持和错误处理

### Milvus连接 (MilvusConnection.py)

#### 主要功能
1. **连接管理**
   - 实现`MilvusConnection`类封装连接操作
   - 支持上下文管理器接口(with语句)
   - 提供连接参数配置

2. **集合操作**
   - 支持集合的创建、查询和删除
   - 提供集合元数据查询
   - 实现实体数量统计

3. **查询功能**
   - 提供集合描述信息查询
   - 支持查询段信息获取
   - 实现实体计数功能

#### 技术实现
- 使用PyMilvus客户端库
- 实现连接池管理
- 提供静态方法简化操作
- 支持安全断开连接

### Milvus参数 (MilvusParams.py)

#### 主要功能
1. **索引类型定义**
   - 使用`IndexType`枚举定义支持的索引类型
   - 包括IVF_FLAT、IVF_SQ8、HNSW等多种索引
   - 提供自动索引选项

2. **参数生成**
   - 实现`get_index_param`函数生成索引参数
   - 为不同索引类型提供优化参数
   - 支持参数自定义

#### 技术实现
- 使用IntEnum定义索引类型
- 提供索引参数字典映射
- 支持JSON格式参数生成

### NebulaGraph存储 (NebulaStore.py & NebulaGraph.py)

#### 主要功能
1. **图数据模型**
   - 定义`Tag`和`Edge`类表示节点和边
   - 实现`Prop`类表示属性
   - 提供数据类型和约束支持

2. **图空间管理**
   - 支持图空间的创建、使用和删除
   - 提供分区和副本配置
   - 实现空间清空功能

3. **标签和边类型管理**
   - 支持标签和边类型的创建和删除
   - 提供TTL(生存时间)配置
   - 实现属性管理和约束设置

4. **构建器模式**
   - 实现`NebularBuilder`构建器简化创建过程
   - 支持链式调用
   - 提供类型安全的接口

#### 技术实现
- 使用nebula3-python客户端库
- 实现上下文管理器接口
- 提供NGQL语句生成
- 使用数据类和枚举增强类型安全

## 数据模型

### 文档存储模型
- 使用键值对模式存储文档
- 键为文档ID，值为序列化的Document对象
- 支持元数据存储和检索

### 用户数据模型
- **用户表**: 存储用户名、密码哈希、用户组和最后使用的项目
- **项目表**: 存储项目名称、所有者、最后聊天、更新时间和创建时间
- **聊天历史表**: 存储会话ID、描述、所有者、项目和时间信息

### 图数据模型
- **节点(Tag)**: 表示实体，如论文、作者等
- **边(Edge)**: 表示实体间关系，如引用、合作等
- **属性(Prop)**: 表示节点和边的特征，支持多种数据类型

## 工作流程

### 文档存储流程
1. 创建SqliteDocStore实例连接数据库
2. 将Document对象序列化后存储
3. 通过ID检索和获取文档
4. 支持批量操作和迭代访问

### 用户管理流程
1. 创建ProfileStore实例连接用户数据库
2. 初始化用户、项目和聊天历史表
3. 提供用户认证和项目管理功能
4. 维护用户会话和聊天历史

### 向量存储流程
1. 创建MilvusConnection实例连接Milvus服务
2. 管理集合和索引配置
3. 提供向量数据的存储和检索
4. 支持元数据查询和统计

### 图数据存储流程
1. 创建NebulaGraphStore实例连接NebulaGraph服务
2. 管理图空间、标签和边类型
3. 使用构建器模式创建数据模型
4. 提供图数据的增删改查操作

## 技术特点

1. **多存储后端支持**
   - 关系型数据库(SQLite)
   - 向量数据库(Milvus)
   - 图数据库(NebulaGraph)

2. **接口抽象与统一**
   - 实现通用存储接口
   - 提供上下文管理器支持
   - 统一错误处理机制

3. **高效数据访问**
   - 批量操作支持
   - 连接池管理
   - 事务处理

4. **类型安全**
   - 使用泛型增强类型安全
   - 提供枚举类型定义
   - 实现数据验证

## 与其他模块的关系

- **与LLM模块的关系**: 提供向量存储支持RAG功能，存储文档和嵌入向量
- **与Pages模块的关系**: 为页面提供数据访问和管理功能
- **与Preprocess模块的关系**: 存储预处理后的文档和元数据
- **与Config模块的关系**: 从配置获取连接参数和存储路径

## 配置依赖

- 需要配置SQLite数据库文件路径
- 需要配置Milvus服务连接参数
- 可选配置NebulaGraph服务连接参数
- 依赖用户权限和认证配置
